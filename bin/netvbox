#!/usr/bin/env ruby

require 'netvbox/vm_set_config'
require 'netvbox/vm_set_manager'
require 'netvbox/printing_delegator'
require 'netvbox/version'

NETVBOX_HOME = "#{ENV['HOME']}/.netvbox"

def print_help
  puts "NetVbox #{NetVbox::VERSION}"
  puts "Config path: #{NETVBOX_HOME}"
  puts
  puts 'SUB-COMMANDS'
  puts '    add <ssh host> <username> <password> <vm name> <snapshot name>'
  puts '        adds a vm snapshot on the specified host'
  puts '    list'
  puts '        lists vm snapshots'
  puts '    load'
  puts '        loads vm snapshots'
  puts '    poweroff'
  puts '        powers off all vms'
  puts '    remove <ssh host> <username> <vm name> <snapshot name>'
  puts '        removes a vm snapshot from management'
  puts '    status'
  puts '         shows status of vms'
  puts
  puts 'VM SET SUB-COMMANDS'
  puts '    createset <set name>'
  puts '         creates a vm set with the specified name'
  puts '    currentset'
  puts '         shows the current vm set in use'
  puts '    listsets'
  puts '         lists all vm sets'
  puts '    removeset <set name>'
  puts '         removes the vm set with the specified name'
  puts '    usedefaultset'
  puts '         uses the default vm set'
  puts '    useset <set name>'
  puts '         uses the vm set with the specified name'
end

def expect_args(num_expected_args)
  if ARGV.length == num_expected_args
    yield ARGV
  else
    puts 'Wrong number of arguments'
    print_help
  end
end

def process_args
  command = ARGV[0]
  vm_set_manager = NetVbox::VmSetManager.new(NETVBOX_HOME)
  vm_set = vm_set_manager.current_set
  delegator = NetVbox::PrintingDelegator.new(vm_set_manager, vm_set)
  case command
  when 'add'
    expect_args(6) do
      hostname, username, password, vm_name, snapshot_name = ARGV[1..5]
      delegator.add_vm(hostname, username, password, vm_name, snapshot_name)
    end
  when 'list'
    delegator.list_vms
  when 'load'
    delegator.load_snapshots
  when 'poweroff'
    delegator.poweroff_all
  when 'remove'
    expect_args(5) do
      hostname, username, vm_name, snapshot_name = ARGV[1..4]
      delegator.remove_vm(hostname, username, vm_name, snapshot_name)
    end
  when 'status'
    delegator.print_status
  when 'createset'
    expect_args(2) {delegator.create_set ARGV[1]}
  when 'currentset'
    delegator.print_current_set
  when 'listsets'
    delegator.list_sets
  when 'removeset'
    expect_args(2) {delegator.remove_set ARGV[1]}
  when 'usedefaultset'
    delegator.use_default_set
  when 'useset'
    expect_args(2) {delegator.use_set ARGV[1]}
  else
    puts "Unknown command: #{command}. See help."
  end
end

if ARGV.empty?
  print_help
else
  process_args
end
